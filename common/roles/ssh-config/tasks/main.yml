---
# tasks file for config-ssh

- name: return hostname
  command: hostname
  register: myhostname

- name: For each host, scan for its ssh public key
  shell: "ssh-keyscan {{ item }}"
  with_items: "{{ ssh_known_hosts }}"
  register: ssh_known_host_results
  ignore_errors: yes
  
- name: Create the "{{ ssh_directory }}" directory if it doesn't exist
  file:
    path: "{{ ssh_directory }}" 
    state: directory
    mode: 0755  
  
- name: Touch the "{{ ssh_auth_keys_file }}" file
  file:
    path: "{{ ssh_auth_keys_file }}"
    state: touch
    mode: "u=rw,g=r,o=r"
 
- name: Remove the public key in the '{{ ssh_known_hosts_file }}'
  known_hosts:
    name: "{{ item.item }}"
    state: "absent"
    path: "{{ ssh_known_hosts_file }}"
  with_items: "{{ ssh_known_host_results.results }}"
    
- name: Add/update the public key in the '{{ ssh_auth_keys_file }}'
  known_hosts:
    name: "{{ item.item }}"
    key: "{{ item.stdout }}"
    state: "present"
    path: "{{ ssh_auth_keys_file }}"
  with_items: "{{ ssh_known_host_results.results }}"
      
- name: Set up multiple authorized keys 
  authorized_key:
    state: present
    user: awx
    key: "{{ item.stdout }}"
    path: "{{ ssh_known_hosts_file }}"
  with_items: "{{ ssh_known_host_results.results }}"
